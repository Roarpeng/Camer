# MQTT摄像头监控系统 - 快速调试指南

## 🚀 快速启动步骤

### 方法1：增强版启动（推荐）
```bash
python 启动增强监控.py
```

### 方法2：测试模式启动（无需真实摄像头）
```bash
python test_enhanced_monitor.py
```

### 方法3：原版启动
```bash
python main.py
```

### 方法4：问题诊断
```bash
python 诊断修复.py
```

## ⚠️ 解决"只显示一个黑色视窗"问题

如果遇到只显示一个黑色视窗的问题，请按以下步骤解决：

### 步骤1：运行诊断工具
```bash
python 诊断修复.py
```
- 自动检测摄像头连接状态
- 测试OpenCV功能
- 生成详细诊断报告

### 步骤2：使用增强版启动
```bash
python 启动增强监控.py
```
- 自动创建6个独立视窗
- 启动控制面板和日志系统
- 支持每个摄像头独立配置

### 步骤3：测试模式验证
```bash
python test_enhanced_monitor.py
```
- 无需真实摄像头
- 模拟6个摄像头画面
- 验证界面功能正常

## 🎯 预期效果

启动成功后应该看到：
- **6个摄像头视窗**：排列成3×2网格，每个显示对应摄像头画面
- **控制面板窗口**：包含3个标签页
  - 摄像头控制：每个摄像头的参数调整滑块
  - 系统日志：实时日志显示
  - 系统状态：整体状态监控

## 🔧 常见调试问题及解决方案

### 问题1：图像太暗
**现象**：6个视窗中图像很暗，看不清红光
**解决方案**：
```yaml
# 在 config.yaml 中调整
cameras:
  brightness: 80        # 增加亮度
  exposure: 200         # 增加曝光时间
  auto_exposure: false  # 关闭自动曝光
```

### 问题2：图像太亮/过曝
**现象**：图像发白，红光区域不明显
**解决方案**：
```yaml
cameras:
  brightness: 40        # 降低亮度
  exposure: 60          # 减少曝光时间
  auto_exposure: false
```

### 问题3：检测不到红光变化
**现象**：红光明显变化但系统不触发
**解决方案**：
```yaml
red_light_detection:
  sensitivity: 0.9              # 提高灵敏度
  area_change_threshold: 0.05   # 降低触发阈值到5%
  min_contour_area: 50          # 降低最小检测面积
```

### 问题4：误触发太多
**现象**：轻微变化就触发，产生误报
**解决方案**：
```yaml
red_light_detection:
  sensitivity: 0.7              # 降低灵敏度
  area_change_threshold: 0.2    # 提高触发阈值到20%
  min_contour_area: 200         # 提高最小检测面积
  baseline_duration: 1.5        # 延长基线建立时间
```

### 问题5：响应太慢
**现象**：changeState变化后很久才开始检测
**解决方案**：
```yaml
red_light_detection:
  baseline_duration: 0.2        # 缩短基线建立时间到0.2秒
cameras:
  fps: 60                       # 提高帧率
```

## 📊 实时调试监控

### 1. 观察视窗显示
- **绿色框**：表示检测到红光区域
- **红色文字**：表示摄像头错误
- **数字显示**：显示检测到的红光数量

### 2. 查看控制台输出
```
INFO - MQTT message received with 3 ones
INFO - Cameras activated successfully  
INFO - Baseline establishment process started
INFO - Trigger condition detected for camera 2: count 5 -> 3, area 1250.50 -> 890.20
INFO - Trigger message published successfully
```

### 3. 检查日志文件
```bash
tail -f mqtt_camera_monitoring.log
```

## ⚡ 快速配置模板

### 室内环境配置
```yaml
cameras:
  brightness: 65
  exposure: 150
  auto_exposure: false

red_light_detection:
  baseline_duration: 0.5
  area_change_threshold: 0.1
  sensitivity: 0.8
```

### 室外/强光环境配置
```yaml
cameras:
  brightness: 35
  exposure: 80
  auto_exposure: false

red_light_detection:
  baseline_duration: 0.3
  area_change_threshold: 0.15
  sensitivity: 0.8
```

### 高精度检测配置
```yaml
cameras:
  brightness: 55
  exposure: 120
  auto_exposure: false

red_light_detection:
  baseline_duration: 1.0
  area_change_threshold: 0.05
  sensitivity: 0.9
  min_contour_area: 50
```

## 🔍 调试技巧

### 1. 逐步调试法
1. 先确保6个摄像头都能正常显示
2. 调整亮度和曝光，确保红光清晰可见
3. 测试红光检测是否准确（观察绿色检测框）
4. 调整触发参数，测试变化检测

### 2. 参数调整顺序
1. **亮度** → 确保图像明暗适中
2. **曝光** → 确保红光清晰不模糊
3. **灵敏度** → 确保能检测到红光
4. **阈值** → 确保触发条件合适
5. **基线时间** → 确保响应速度合适

### 3. 测试方法
1. **手动遮挡测试**：用手遮挡部分红光，观察是否触发
2. **光源变化测试**：改变红光亮度，测试面积变化检测
3. **多摄像头测试**：确保6个摄像头都能正常工作
4. **长时间测试**：运行数小时确保稳定性

## 📋 调试检查清单

- [ ] 6个USB摄像头都已连接并被识别
- [ ] 6个视窗都能正常显示图像
- [ ] MQTT连接正常（检查控制台输出）
- [ ] 图像亮度适中，红光清晰可见
- [ ] 红光检测正常（有绿色检测框）
- [ ] changeState消息能触发摄像头激活
- [ ] 红光变化能正确触发系统响应
- [ ] 触发消息能正常发送到MQTT

## 🆘 紧急故障处理

### 系统无响应
```bash
# 强制停止
Ctrl+C

# 检查进程
ps aux | grep python

# 重启系统
python main.py
```

### 摄像头卡死
```bash
# 重新插拔USB摄像头
# 或重启系统
```

### MQTT连接失败
```bash
# 检查网络连接
ping 192.168.10.80

# 检查MQTT服务器状态
# 确认端口1883开放
```

记住：调试时建议将日志级别设为 `DEBUG`，正式运行时改为 `INFO`。