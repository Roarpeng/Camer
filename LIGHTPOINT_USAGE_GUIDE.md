# 光点检测系统使用指南

## 系统概述
基于mask.png的光点检测系统，将每个白色连通区域识别为一个独立的光点，检测红色光点的变化。

## 重要更新

### 🔧 红色检测优化
- **更宽松的HSV范围**: 降低饱和度和亮度要求，提高检测敏感度
- **更低的红色比例阈值**: 从30%降低到10%，更容易检测到红色光点
- **触发条件优化**: 相差1个光点就触发上报，提高响应灵敏度

### 📊 当前参数
- **光点数量**: 20个独立光点区域
- **红色HSV范围1**: [0, 30, 30] - [25, 255, 255]
- **红色HSV范围2**: [155, 30, 30] - [180, 255, 255]
- **红色比例阈值**: 10% (光点区域内红色像素比例)
- **触发条件**: 红色光点数量相差 ≥1 个

## 使用流程

### 1. 系统验证
```bash
run_verify_lightpoint_system.bat
```
确认所有组件功能正常，验证20个光点识别正确。

### 2. 红色检测测试
```bash
run_red_detection_test.bat
```
**功能**: 测试当前红色检测参数是否能正确检测红色光点
**操作**: 按SPACE键测试当前帧的红色检测效果
**用途**: 验证基线建立前是否能检测到红色光点

### 3. 可视化调试
```bash
run_lightpoint_visualizer.bat
```
**显示模式**:
- **模式0**: 光点轮廓 - 显示所有光点边界
- **模式1**: 光点编号 - 显示光点ID便于识别
- **模式2**: 红色检测 - 高亮当前红色光点
- **模式3**: 变化对比 - 对比基线和当前状态

**操作流程**:
1. 启动工具，观察20个光点区域
2. 按M切换到模式2，查看红色检测效果
3. 按SPACE建立基线（采集当前红色光点）
4. 按M切换到模式3，观察变化对比
5. 移动或遮挡红色光源，观察变化检测

### 4. 生产运行
```bash
run_lightpoint_system.bat
```
完整的MQTT触发检测系统，支持自动基线建立和变化上报。

## 故障排除

### 问题1: 基线没有检测到红色光点

**现象**: 基线建立时红色光点数为0

**排查步骤**:
1. **使用红色检测测试工具**:
   ```bash
   run_red_detection_test.bat
   ```
   按SPACE测试当前帧，查看是否能检测到红色光点

2. **检查光照条件**:
   - 确保红色光源足够亮
   - 避免环境光过强干扰
   - 调整摄像头曝光设置

3. **使用可视化工具调试**:
   ```bash
   run_lightpoint_visualizer.bat
   ```
   - 切换到模式2查看红色检测效果
   - 观察光点区域是否正确识别为红色

4. **检查红色光源**:
   - 确认光源确实是红色
   - 检查光源是否在mask定义的区域内
   - 验证光源亮度是否足够

**解决方案**:
- 如果检测参数需要调整，可以修改系统文件中的HSV范围
- 降低红色比例阈值（当前为10%）
- 调整光照环境或红色光源亮度

### 问题2: 触发过于敏感或不敏感

**现象**: 系统触发频率不符合预期

**当前设置**: 相差1个光点就触发上报

**调整方法**:
1. 修改 `mask_lightpoint_detection_system.py` 中的触发条件
2. 当前代码: `if count_difference >= 1:`
3. 可以调整为: `if count_difference >= 2:` (相差2个光点才触发)

### 问题3: 红色检测不准确

**现象**: 非红色光点被误识别为红色，或红色光点未被识别

**调试工具**:
```bash
run_red_detection_test.bat
```

**参数调整**:
- **HSV色调范围**: 调整H值范围
- **饱和度要求**: 调整S值下限
- **亮度要求**: 调整V值下限
- **红色比例阈值**: 调整百分比要求

## 技术参数详解

### 光点识别参数
- **最小光点面积**: 10像素
- **白色阈值**: >200灰度值
- **连通区域算法**: RETR_EXTERNAL

### 红色检测参数
```python
# HSV范围1 (主要红色)
red_hsv_lower1 = [0, 30, 30]    # 色调0°, 饱和度30, 亮度30
red_hsv_upper1 = [25, 255, 255] # 色调25°, 饱和度255, 亮度255

# HSV范围2 (深红色)
red_hsv_lower2 = [155, 30, 30]  # 色调155°, 饱和度30, 亮度30
red_hsv_upper2 = [180, 255, 255] # 色调180°, 饱和度255, 亮度255

# 红色比例阈值
red_ratio_threshold = 0.1  # 10%的像素为红色就认定为红色光点
```

### 检测时序参数
- **检测频率**: 20 FPS (每0.05秒)
- **监控间隔**: 每0.2秒检测变化
- **基线延迟**: MQTT触发后0.1秒建立
- **触发条件**: 红色光点数量相差≥1个

## 性能监控

### 系统状态输出
系统每10秒输出一次状态信息:
```
系统状态: 运行=True, 活跃摄像头=1, 总光点数=20, MQTT触发=False
摄像头 0: 基线红色光点数=5, 当前红色光点数=4, 检测次数=125
```

### 变化检测日志
当检测到变化时输出:
```
摄像头 0 检测到光点变化: 基线=5, 当前=4, 差异=1个光点
摄像头 0 触发MQTT消息成功 (光点变化: 1)
```

## 最佳实践

### 环境设置
1. **稳定光照**: 避免环境光变化影响检测
2. **红色光源**: 使用纯红色LED或激光
3. **摄像头固定**: 确保摄像头位置稳定
4. **mask对齐**: 确保mask区域与实际光点位置对齐

### 调试流程
1. **验证系统** → 确认20个光点识别正确
2. **测试红色检测** → 验证能检测到红色光点
3. **可视化调试** → 观察实时检测效果
4. **建立基线** → 在稳定状态下建立基线
5. **测试变化** → 验证变化检测和上报功能

### 参数优化
1. **从宽松开始**: 使用较宽松的检测参数
2. **逐步收紧**: 根据实际效果调整参数
3. **记录最佳参数**: 保存有效的参数配置
4. **环境适配**: 针对不同环境调整参数

## 扩展功能

### 未来改进
1. **自适应阈值**: 根据环境自动调整检测参数
2. **多颜色支持**: 支持检测其他颜色的光点
3. **亮度变化检测**: 检测光点亮度变化
4. **历史数据分析**: 记录和分析检测历史

### 自定义配置
- 修改HSV范围适应不同红色光源
- 调整红色比例阈值适应不同光点大小
- 修改触发条件适应不同应用场景
- 调整检测频率平衡性能和精度