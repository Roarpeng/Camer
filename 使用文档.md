# MQTT摄像头监控系统 - 使用文档

## 系统概述

MQTT摄像头监控系统是一个基于Python的增强型实时监控解决方案，具备以下核心功能：

### 🎥 6个独立摄像头视窗
- 同时显示6个USB摄像头的实时画面
- 每个视窗独立显示摄像头ID、参数设置和检测状态
- 支持实时参数调整和状态监控

### ⚙️ 独立参数配置
- **每个摄像头可单独配置**：亮度、曝光、对比度、饱和度
- **实时调整**：通过控制面板即时调整参数，无需重启
- **自动/手动曝光**：支持每个摄像头独立的曝光模式

### 📊 实时日志监控
- **右侧日志面板**：显示系统运行状态、检测信息、触发记录
- **分类显示**：错误、警告、信息等不同级别的日志
- **实时更新**：画面初始值、触发信息、检测变化等实时记录

### 🔍 智能检测系统
- 监听MQTT消息变化并自动激活摄像头
- 检测红光数量和面积变化
- 在检测到变化时发送触发消息

## 系统要求

### 硬件要求
- 6个USB摄像头
- 支持USB 2.0/3.0的计算机
- 足够的USB端口或USB集线器

### 软件要求
- Python 3.8+
- OpenCV
- MQTT客户端库
- 详细依赖见 `requirements.txt`

## 安装步骤

1. **克隆或下载项目文件**
2. **安装Python依赖**：
   ```bash
   pip install -r requirements.txt
   ```
3. **连接6个USB摄像头**到计算机
4. **配置系统参数**（见配置章节）

## 配置文件说明

配置文件 `config.yaml` 包含所有系统参数：

### MQTT配置
```yaml
mqtt:
  broker_host: "192.168.10.80"    # MQTT服务器地址
  broker_port: 1883               # MQTT端口
  client_id: "receiver"           # 客户端ID
  subscribe_topic: "changeState"  # 订阅的主题
  publish_topic: "receiver/triggered"  # 发布触发消息的主题
```

### 摄像头配置
```yaml
cameras:
  count: 6                    # 摄像头数量（固定为6）
  resolution_width: 640       # 分辨率宽度
  resolution_height: 480      # 分辨率高度
  fps: 30                     # 帧率
  brightness: 50              # 亮度 (0-100)
  exposure: 100               # 曝光值 (毫秒)
  contrast: 50                # 对比度 (0-100)
  saturation: 50              # 饱和度 (0-100)
  auto_exposure: true         # 自动曝光开关
```

### 红光检测配置
```yaml
red_light_detection:
  baseline_duration: 1.0      # 基线建立时间（秒）
  area_change_threshold: 0.1  # 面积变化阈值（10%）
  sensitivity: 0.8            # 检测灵敏度
  min_contour_area: 100       # 最小轮廓面积
```

### 视窗显示配置
```yaml
visual_monitor:
  window_width: 320           # 视窗宽度
  window_height: 240          # 视窗高度
  show_detection_boxes: true  # 显示检测框
  box_color: [0, 255, 0]      # 检测框颜色（绿色）
```

## 启动系统

### 基本启动
```bash
python main.py
```

### 测试启动（无需真实摄像头）
```bash
python test_enhanced_monitor.py
```

### 启动过程
1. **配置加载**：系统加载配置文件，包括每个摄像头的独立设置
2. **MQTT连接**：连接到MQTT服务器
3. **摄像头初始化**：初始化6个USB摄像头，应用各自的参数设置
4. **界面创建**：
   - 创建6个独立的摄像头显示视窗
   - 启动控制面板（包含参数调整和日志显示）
5. **系统就绪**：开始监听MQTT消息并显示实时画面

### 界面布局
- **左侧**：6个摄像头视窗（3×2网格布局）
- **右侧**：控制面板窗口
  - **摄像头控制**标签：每个摄像头的参数调整滑块
  - **系统日志**标签：实时日志显示和导出功能
  - **系统状态**标签：整体系统状态监控

## 调试参数调整

### 1. 调整摄像头亮度
在 `config.yaml` 中修改：
```yaml
cameras:
  brightness: 75    # 增加亮度 (0-100)
```

**调试建议**：
- 环境较暗：设置为 70-90
- 环境较亮：设置为 30-50
- 正常环境：设置为 50

### 2. 调整摄像头曝光
```yaml
cameras:
  exposure: 150     # 增加曝光时间 (毫秒)
  auto_exposure: false  # 关闭自动曝光进行手动调整
```

**调试建议**：
- 图像过暗：增加曝光值到 150-300
- 图像过亮：减少曝光值到 50-100
- 运动模糊：减少曝光值到 30-80

### 3. 调整基线拍摄时长
```yaml
red_light_detection:
  baseline_duration: 0.3    # 改为0.3秒建立基线
```

**说明**：
- 系统检测到 `changeState` 消息变化后
- 在指定时间内（如0.3秒）建立红光检测基线
- 然后开始持续监控与基线的差异

### 4. 调整触发灵敏度
```yaml
red_light_detection:
  area_change_threshold: 0.05  # 5%面积变化即触发
  sensitivity: 0.9             # 提高检测灵敏度
```

## 系统工作流程

### 1. 初始化阶段
- 连接6个USB摄像头
- 显示6个独立视窗
- 连接MQTT服务器
- 等待 `changeState` 消息

### 2. 激活阶段
- 接收到 `changeState` 消息变化
- 激活所有摄像头开始拍摄
- 在配置的时间内（如0.3秒）建立红光基线

### 3. 监控阶段
- 持续检测每个摄像头的红光
- 与基线进行数量和面积比较
- 检测到变化时发送触发消息

### 4. 触发条件
满足以下任一条件即触发：
- **红光数量减少**：检测到的红光个数比基线少
- **红光面积变化**：总面积变化超过设定阈值

## 视窗显示说明

### 6个视窗布局
- 系统自动创建6个独立视窗
- 每个视窗对应一个USB摄像头
- 视窗标题显示摄像头编号（Camera 0-5）

### 视觉指示
- **绿色框**：检测到的红光区域
- **红色文字**：摄像头错误或断开
- **状态信息**：显示检测状态和计数

## 故障排除

### 摄像头问题
1. **摄像头无法初始化**
   - 检查USB连接
   - 确认摄像头驱动正常
   - 尝试减少摄像头数量测试

2. **图像质量问题**
   - 调整亮度和曝光参数
   - 检查摄像头镜头清洁度
   - 调整环境光照条件

### MQTT连接问题
1. **无法连接MQTT服务器**
   - 检查网络连接
   - 确认服务器地址和端口
   - 检查防火墙设置

### 检测精度问题
1. **误检测或漏检测**
   - 调整红光检测的HSV颜色范围
   - 修改最小轮廓面积参数
   - 调整灵敏度设置

## 日志和监控

### 日志文件
- 日志文件：`mqtt_camera_monitoring.log`
- 包含系统状态、错误信息、触发记录

### 实时监控
- 控制台输出实时状态信息
- 视窗显示检测结果
- MQTT消息收发记录

## 性能优化建议

### 1. 硬件优化
- 使用USB 3.0端口获得更好性能
- 确保足够的系统内存
- 使用SSD提高I/O性能

### 2. 软件优化
- 根据需要调整分辨率和帧率
- 优化检测参数减少计算负载
- 定期清理日志文件

## 配置示例

### 高灵敏度配置（适用于精确检测）
```yaml
cameras:
  brightness: 60
  exposure: 120
  auto_exposure: false

red_light_detection:
  baseline_duration: 0.5
  area_change_threshold: 0.05
  sensitivity: 0.9
  min_contour_area: 50
```

### 快速响应配置（适用于快速变化）
```yaml
cameras:
  fps: 60
  brightness: 70
  exposure: 80

red_light_detection:
  baseline_duration: 0.2
  area_change_threshold: 0.15
  sensitivity: 0.8
```

### 稳定检测配置（适用于减少误报）
```yaml
red_light_detection:
  baseline_duration: 1.5
  area_change_threshold: 0.2
  sensitivity: 0.7
  min_contour_area: 200
```

## 技术支持

如遇到问题，请检查：
1. 日志文件中的错误信息
2. 摄像头硬件连接状态
3. MQTT服务器连接状态
4. 配置文件参数设置

系统设计为7x24小时稳定运行，支持自动重连和错误恢复功能。