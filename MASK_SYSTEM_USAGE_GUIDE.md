# Mask系统使用指南

## 系统概述
基于mask.png的1080p红色光点检测系统，支持实时画面和mask对齐显示，mask非白色区域全黑处理。

## 快速开始

### 1. 系统验证
首先运行系统验证，确保所有组件正常：
```bash
run_verify_mask_system.bat
```

### 2. 调试阶段

#### 快速黑化效果测试
```bash
run_mask_blackout_test.bat
```
- 验证mask黑化效果
- 3种显示模式：原图、黑化mask叠加、半透明mask叠加
- 控制：1/2/3切换模式，Q退出

#### 完整可视化调试
```bash
run_mask_alignment_visualizer.bat
```
- 实时显示摄像头画面和mask对齐情况
- 4种显示模式：黑化mask、仅mask区域、红色检测、半透明叠加
- 支持基线建立和红色光点变化检测

**控制说明：**
- `SPACE` - 建立基线（采集mask区域内红色光点）
- `R` - 重置基线
- `M` - 切换显示模式
- `Q` - 退出

**显示模式：**
- **模式0 (黑化mask)**: 原图 + mask非白色区域全黑 + 红色光点标记
- **模式1 (仅mask)**: 只显示mask区域内的图像
- **模式2 (红色检测)**: 高亮显示检测到的红色区域
- **模式3 (半透明)**: 原图 + 半透明绿色mask叠加

### 3. 生产运行
```bash
run_mask_1080p_system.bat
```
- 完整的MQTT触发和上报功能
- 自动基线建立和监控
- 红色光点变化检测和上报

## 技术规格

### 分辨率配置
- **摄像头分辨率**: 1920x1080 (Full HD)
- **Mask文件**: mask.png (自动缩放到1080p)
- **检测点数**: 109,601个白色mask点
- **Mask覆盖率**: 5.3%

### 红色检测参数
- **HSV范围1**: [0, 50, 50] - [20, 255, 255]
- **HSV范围2**: [160, 50, 50] - [180, 255, 255]
- **白色阈值**: >200 (灰度值)

### 检测逻辑
1. **基线建立**: 只采集mask白色区域内的红色光点
2. **实时监控**: 检测红色光点的出现/消失变化
3. **触发条件**: 当红色光点数量发生变化时触发MQTT上报

## 文件结构

### 核心系统文件
- `mask_1080p_detection_system.py` - 主检测系统
- `mask_alignment_visualizer.py` - 可视化调试工具
- `test_mask_blackout.py` - 黑化效果测试
- `verify_mask_system.py` - 系统功能验证

### 批处理文件
- `run_mask_1080p_system.bat` - 运行主系统
- `run_mask_alignment_visualizer.bat` - 运行可视化工具
- `run_mask_blackout_test.bat` - 运行黑化测试
- `run_verify_mask_system.bat` - 运行系统验证

### 配置文件
- `config.yaml` - 系统配置（摄像头、MQTT等）
- `mask.png` - 1080p标准mask图片

## 使用流程

### 调试流程
1. **验证系统** → `run_verify_mask_system.bat`
2. **测试黑化** → `run_mask_blackout_test.bat`
3. **可视化调试** → `run_mask_alignment_visualizer.bat`
   - 按SPACE建立基线
   - 按M切换显示模式
   - 验证红色光点检测效果

### 生产流程
1. **启动系统** → `run_mask_1080p_system.bat`
2. **MQTT触发** → 系统接收changeState消息
3. **基线建立** → 自动采集mask区域内红色光点
4. **实时监控** → 检测红色光点变化
5. **触发上报** → 发送MQTT消息

## 故障排除

### 常见问题

#### 1. 摄像头分辨率不匹配
**现象**: 验证失败，摄像头不支持1080p
**解决**: 检查摄像头规格，或修改config.yaml中的分辨率设置

#### 2. Mask文件问题
**现象**: mask.png不存在或无法读取
**解决**: 确保mask.png文件在当前目录，且为有效图片格式

#### 3. 红色检测不准确
**现象**: 红色光点检测过多或过少
**解决**: 调整HSV参数，或使用可视化工具进行调试

#### 4. MQTT连接失败
**现象**: 系统启动但MQTT连接失败
**解决**: 检查config.yaml中的MQTT配置，确保服务器可达

### 调试技巧

1. **使用可视化工具**: 实时查看检测效果
2. **切换显示模式**: 不同模式帮助定位问题
3. **建立基线测试**: 验证红色光点采集是否正确
4. **查看日志文件**: mask_1080p_detection.log包含详细信息

## 性能优化

### 检测性能
- 检测频率: 20 FPS (每0.05秒)
- 监控间隔: 每0.2秒检测一次变化
- 状态输出: 每5秒输出一次状态

### 显示性能
- 可视化工具自动缩放显示窗口到50%
- 大量检测点时自动采样显示
- 支持实时帧率显示

## 扩展功能

### 未来改进方向
1. 支持多摄像头同时检测
2. 添加检测敏感度调节
3. 支持不同颜色光点检测
4. 添加检测结果统计分析
5. 优化大量检测点的性能

### 自定义配置
- 修改config.yaml调整摄像头参数
- 调整HSV范围适应不同光照条件
- 修改检测频率和触发条件