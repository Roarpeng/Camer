# 基于mask.png的1080p检测系统总结

## 系统概述
- 使用 `mask.png` 作为1080p标准mask对比图
- 基线采集时只采集白色区域内的红色光点
- 提供实时画面和mask对齐显示用于调试

## 技术规格

### 分辨率配置
- **目标分辨率**: 1920x1080 (Full HD)
- **Mask文件**: mask.png (原始: 1536x2752, 自动缩放到1080p)
- **摄像头配置**: 1920x1080
- **检测点数**: 109,601个白色mask点

### 检测逻辑
1. **基线建立**: 只采集mask白色区域内的红色光点
2. **实时监控**: 检测红色光点的出现/消失变化
3. **触发条件**: 当红色光点数量发生变化时触发MQTT上报

## 核心文件

### 主要检测系统
- `mask_1080p_detection_system.py` - 完整的1080p检测系统
  - 支持MQTT触发和上报
  - 只在mask白色区域内检测红色光点
  - 自动缩放mask到1080p分辨率

### 调试可视化工具
- `mask_alignment_visualizer.py` - 实时对齐显示工具
  - 三种显示模式：叠加显示、仅mask区域、红色检测结果
  - 实时显示基线和当前红色光点
  - 支持基线建立和重置

### 批处理文件
- `run_mask_1080p_system.bat` - 运行完整检测系统
- `run_mask_alignment_visualizer.bat` - 运行可视化调试工具
- `run_mask_blackout_test.bat` - 运行mask黑化效果测试

## 红色检测参数

### HSV颜色范围
- **范围1**: [0, 100, 100] - [10, 255, 255]
- **范围2**: [170, 100, 100] - [180, 255, 255]
- **特点**: 更严格的饱和度和亮度要求，减少误检

### Mask处理
- **白色阈值**: >200 (灰度值)
- **缩放方法**: INTER_NEAREST (保持二值特性)
- **自动适配**: 任意尺寸mask自动缩放到1080p

## 使用说明

### 1. 调试阶段 - 对齐验证

#### 完整可视化工具
```bash
run_mask_alignment_visualizer.bat
```

#### 快速黑化效果测试
```bash
run_mask_blackout_test.bat
```

**功能**:
- 实时显示摄像头画面和mask对齐情况
- 验证mask区域覆盖是否正确
- 测试红色光点检测效果

**控制**:
- `SPACE` - 建立基线 (采集mask区域内红色光点)
- `R` - 重置基线
- `M` - 切换显示模式 (黑化mask/仅mask/红色检测/半透明)
- `Q` - 退出

**显示模式**:
- **模式0 (黑化mask)**: 原图 + mask非白色区域全黑处理 + 红色光点标记
- **模式1 (仅mask)**: 只显示mask区域内的图像
- **模式2 (红色检测)**: 高亮显示检测到的红色区域
- **模式3 (半透明)**: 原图 + 半透明绿色mask叠加

### 2. 生产运行 - 完整检测系统
```bash
run_mask_1080p_system.bat
```

**功能**:
- 完整的MQTT触发和上报功能
- 自动基线建立和监控
- 红色光点变化检测和上报

## 检测流程

### 基线建立阶段
1. 接收MQTT changeState消息
2. 验证触发条件 (排除144个ones等)
3. 延迟0.1秒后捕获基线帧
4. **只提取mask白色区域内的红色光点**
5. 记录基线红色光点坐标和数量

### 监控阶段
1. 每0.2秒检测一次
2. 提取当前帧mask区域内的红色光点
3. 与基线对比，计算变化:
   - 消失的红色光点 (基线有，当前没有)
   - 新出现的红色光点 (基线没有，当前有)
4. 如有变化，触发MQTT上报

## 验证结果

### 分辨率对齐
- ✅ mask.png成功缩放: 1536x2752 → 1080x1920
- ✅ 摄像头输出: 1080x1920
- ✅ 完全匹配1080p分辨率

### 检测能力
- ✅ 109,601个mask检测点
- ✅ 精确的红色HSV检测
- ✅ 只在mask白色区域内检测
- ✅ 实时变化监控和上报

## 优势特点

1. **精确定位**: 只在mask定义的白色区域内检测
2. **高分辨率**: 支持1080p全高清检测
3. **自动适配**: mask自动缩放到目标分辨率
4. **可视化调试**: 提供实时对齐显示工具
5. **灵活配置**: 支持HSV参数调整
6. **稳定可靠**: 基于成熟的OpenCV算法

## 下一步优化

1. 支持多摄像头同时检测
2. 添加检测敏感度调节
3. 优化大量检测点的性能
4. 添加检测结果统计和分析
5. 支持不同颜色光点检测