# 项目规格说明书: Camer

## 1. 项目概述
**目标**: 开发一个基于 USB 摄像头的计算机视觉应用，具备实时监控、掩码（Mask）处理、基线建立及触发功能。
**核心要求**: 高性能、实时性、用户友好的 GUI 交互。

## 2. 技术栈
- **语言**: Python 3.11 (基于 `camer311` 环境)
- **视觉处理**: OpenCV (`cv2`) - 用于图像采集、掩码应用和处理。
- **界面开发**: Qt (PySide6 或 PyQt6) - 保证 GUI 线程安全与响应速度。
- **数值计算**: Numpy - 高效矩阵运算。
- **通信**: MQTT (`paho-mqtt`) - (保留原有推断) 用于发送触发信号或数据。

## 3. 功能需求

### 3.1 硬件输入
- **设备**: USB 摄像头。
- **配置**: 支持选择不同摄像头（如有多个）。

### 3.2 图形用户界面 (GUI) 布局
界面主要分为左中右三部分：

#### 左侧：控制面板 (Controls)
- **多摄管理**: 支持 3 个摄像头 (Camera 1, 2, 3)。
- **激活开关**: 每个摄像头都有独立的“激活/禁用”勾选框。
- **掩码选择**: 每个摄像头独立选择对应的掩码图像（下拉框）。
- **基线控制**: 统一或独立的基线重置按钮。

#### 中间：实时监控 (Monitor)
- **多路显示**: 垂直或网格排列显示 3 路摄像头的处理后画面（Mask 与运算后的数据）。
- **视觉反馈**: 在画面上直接标记异常区域或状态。

#### 右侧：实时日志 (Log)
- **系统日志**: 显示启动、连接状态、错误信息。
- **触发日志**: 显示各摄像头的报警触发信息。

### 3.3 核心处理逻辑
- **掩码应用**: 将选定的掩码图像应用于摄像头采集的帧，仅处理感兴趣区域 (ROI)，提高处理效率。
- **基线算法**: 建立背景模型或参考帧，用于差异检测。
- **触发逻辑**: 当检测区域变化超过阈值时，记录日志并可能发送 MQTT 消息。

## 4. 算法与性能方案 (Algorithm & Performance)
- **推荐算法**: **背景减除 (Background Subtraction) / 帧差法**
    - **理由**: 既然项目强调“建立基线”和“高性能”，相比深度学习模型，传统的图像差分法（如 `cv2.absdiff` 或 `MOG2`）计算量极低，完全能满足 60fps+ 的实时处理需求，且对光照稳定的工业/固定场景效果极佳。
    - **逻辑**: `|当前帧 - 基线帧| > 阈值` (在掩码区域内)。
- **数据文件**: `data` 目录下的 `.jpg` 为快照存档，用于回溯或测试算法时的静态输入。
- **线程架构**:
    - **UI 线程**: Qt Main Loop (仅渲染)。
    - **工作线程**: 采集 + 算法 (避免 GIL 竞争，单纯计算密集型可考虑 multiprocessing，一般 threading 配合 OpenCV C++底层已足够)。

## 5. 项目最终架构 (Final Architecture)
- **多线程/多实例模型**: 
    - 使用 `CameraThread` 类独立管理每个摄像头的采集任务（通过 `QThread` 实现），避免 UI 阻塞。
    - 使用 `ImageProcessor` 类独立处理每路图像的 Mask 叠加和帧差计算。
- **UI 设计**: 
    - **左侧控制区**: 独立控制每个摄像头的激活状态和掩码映射。
    - **中间监控区**: 采用 `QScrollArea` 容纳多路视频流，支持灵活扩展。
    - **右侧日志区**: 沉浸式深色主题日志，实时反馈系统核心事件。
- **路径管理**: 核心组件均采用**脚本基准绝对路径**（Script-relative Absolute Paths），确保在不同目录下运行或打包后，`data/` 资源加载始终正确。

## 6. 运行与维护 (Operations)
- **启动方式**: 建议在项目根目录下执行 `python src/main.py`。代码已具备自动修正 `PYTHONPATH` 的能力。
- **离线部署**: 
    - 使用 `PyInstaller` 构建的独立可执行文件位于 `dist/CamerApp.exe`。
    - 该文件已内置了图标、代码以及初始的 `data/` 掩码资源，可直接分发到远程 Windows 设备运行。
- **常见问题**:
    - **摄像头激活失败**: 请检查摄像头是否被其它程序占用，或索引号（0, 1, 2）是否正确。系统会通过 `QMessageBox` 弹出具体错误提示。
    - **Mask 列表为空**: 请确保 `data/` 文件夹位于项目根目录，且包含 `.png` 或 `.jpg` 格式的掩码文件。
- **日志回溯**: 日志区会详细记录每次基线重置、掩码更换及检测触发事件，便于后期调试。