# 项目规格说明书: Camer

## 1. 项目概述
**目标**: 开发一个支持多路 USB 摄像头的计算机视觉监控应用，具备实时画面处理、掩码（Mask）分析、自动基准建立、亮度扫描及 MQTT 远程控制功能。
**核心要求**: 高性能、实时性、Material Design 交互体验、支持打包分发。

## 2. 技术栈
- **语言**: Python 3.11 (基于 `camer311` 环境)
- **视觉处理**: OpenCV (`cv2`) - 用于图像采集、掩码应用、帧差分析及亮度计算。
- **界面开发**: Qt (PySide6) - 采用 **Material Design 浅色主题**，支持中文字体显示及 GUI 线程安全。
- **数值计算**: Numpy - 高效矩阵运算。
- **通信**: MQTT (`paho-mqtt`) - 
    - **ClientID**: `camer`
    - **自动订阅**: `changeState` (控制) 和 `receiver` (上报)。
    - **动态配置**: 支持通过 UI 实时修改 Broker 地址并重连。

## 3. 功能需求

### 3.1 图形用户界面 (GUI) 布局
界面采用三栏式布局，适配 Material Design 设计规范：

#### 左侧：配置与控制面板 (Controls)
- **MQTT 配置**: 动态修改 Broker 地址，具备实时连接状态反馈（连接成功显示绿色）。
- **多摄管理**: 支持 3 个摄像头 (Camera 1, 2, 3)。
- **激活控制**: 每个摄像头独立勾选启用或停用。
- **掩码选择**: 下拉选择 `data/` 目录下的掩码文件。**未选择时显示完整图像，选择后仅显示 ROI（非感兴趣区域全黑处理）**。
- **灵敏度调节**: 
    - **Sensitivity (阈值)**: 像素差异触发门限。
    - **Min Area (最小面积)**: 过滤噪点，只有达到此面积的变化才触发报警。
- **基线控制**: 支持手动重置各摄像头基准。

#### 中间：实时监控 (Monitor)
- **多路显示**: 实时显示处理后的画面。
- **报警视觉化**: 触发报警时在画面上绘制红色检测框。

#### 右侧：实时日志 (Log)
- 记录系统初始化、摄像头状态、MQTT 连接事件及亮度变化触发。

### 3.2 核心处理逻辑
- **自动基准**: 系统接收到第一帧图像时自动建立初始基准，无需手动干预。
- **掩码逻辑**: 应用选定掩码后，算法仅处理掩码区域，且显示窗口同步切换为 ROI 视图。
- **亮度扫描**: 基准建立后，系统每 **300ms** 对 ROI 区域进行均值亮度扫描。
- **触发机制**:
    1. **像素变化报警**: 帧差面积超过 `Min Area`。
    2. **亮度变化上报**: ROI 亮度显著波动时，向 MQTT `receiver` 主题发布空报文。
- **MQTT 远程控制**: 接收到 `changeState` 主题下的 `"2"` 报文时，触发全局基准重置。

## 4. 架构设计 (Architecture)
- **MqttWorker**: 独立 QObject 管理 MQTT 连接、重连及消息收发逻辑。
- **ImageProcessor**: 封装 OpenCV 算法逻辑，支持掩码管理及亮度计算。
- **CameraThread**: 利用 `QThread` 确保视频采集不阻塞主界面。

## 5. 运行与分发 (Deployment)
- **主程序入口**: `run.py` (根目录)，负责正确加载 `src` 包路径。
- **打包版本**: 使用 `PyInstaller` 封装的 `dist/CamerApp.exe`。
- **资源路径**: 采用资源定位算法，确保图标和 `data/` 掩码在 EXE 模式下依然可访问。

---
*更新日期: 2026-01-07*
